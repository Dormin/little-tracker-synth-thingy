<!DOCTYPE html>
<html>
	<head>
		<title>Test</title>
	</head>
	<body>
		<canvas id="view" width="192" height="144" style="width:384px;height:288px;display:block;margin:auto;image-rendering:pixelated"></canvas>
		<script src="js/audio.js"></script>
		<script src="js/canvas.js"></script>
		<script src="js/input.js"></script>
		<script src="js/synth.js"></script>
		<script src="js/tracker.js"></script>
		<script>
			var KeyToNoteMap = {
				65: -9, // A: C
				87: -8, // W: C#
				83: -7, // S: D
				69: -6, // E: D#
				68: -5, // D: E
				70: -4, // F: F
				84: -3, // T: F#
				71: -2, // G: G
				89: -1, // Y: G#
				72: 0, // H: A
				85: 1, // U: A#
				74: 2, // J: B
				75: 3, // K: C
				79: 4, // O: C#
				76: 5, // L: D
			}
			var NumSynths = 1
			var CurrKey = 0

			InitSynths(Tracker.NumTracks)
			InitInput()
			InitCanvas("view")
			InitTracker()

			var Font = LoadImage("img/font.png")
			SetColor(128, 128, 128)
			DrawRect(0, 0, Canvas.Width, Canvas.Height)

			StartAudio(OnProcess)

			function OnProcess(OutputL, OutputR, NumSamples, SampleRate) {
				HandleKeyboard()
				ProcessSynth(0, OutputL, OutputR, NumSamples, SampleRate)
			}

			function HandleKeyboard() {
				for (var Key in KeyToNoteMap) {
					if (KeyWasPressed(Key)) {
						var Note = KeyToNoteMap[Key]
						SynthNoteOn(0, Note)
						CurrKey = Key
						DrawNote(Note, 6, 6)
					}
				}

				if (KeyWasReleased(CurrKey)) {
					SynthNoteOff(0)
					CurrKey = 0
				}
			}

			function DrawNote(Note, X, Y) {
				var Octave = ((Note + 9) / 12 | 0) + 4
				Note = (Note % 12 + 12) % 12
				var NoteChar = [65, 65, 66, 67, 67, 68, 68, 69, 70, 70, 71, 71][Note]
				var SharpChar = [45, 35, 45, 45, 35, 45, 35, 45, 45, 35, 45, 35][Note]
				var OctaveChar = 48 + Octave
				SetColor(128, 128, 128)
				DrawRect(X, Y, 18, 6)
				DrawChar(NoteChar, X, Y)
				DrawChar(SharpChar, X + 6, Y)
				DrawChar(OctaveChar, X + 12, Y)
			}

			function DrawChar(Char, X, Y) {
				var Index = Char - 32
				DrawImage(Font, X, Y, Index * 6, 0, 6, 6)
			}
			
		</script>
	</body>
</html>